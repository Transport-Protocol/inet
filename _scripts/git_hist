#! /usr/bin/env python
# This script calls gitk with all historical folders of files of current folder.
#

import fnmatch
import os
import re
import string
import subprocess
import sys

rootPath = '.'
filepattern = '*'
err = 0

paths = set()

print 'argcount:',  len(sys.argv)

#exit(0)

if len(sys.argv) == 2:
    filepattern = sys.argv[1]

for filename in os.listdir(rootPath):
    if fnmatch.fnmatch(filename, filepattern):
        fullpath = os.path.join(rootPath, filename)
        proc = subprocess.Popen(['git', 'log', '-p', '--follow', fullpath], stdout=subprocess.PIPE)
        for line in proc.stdout:
            if line.startswith('diff --git '):
                line = line[11:].rstrip()
                for onefile in line.split(' '):
                    onefile = onefile[2:]
                    histdir = os.path.dirname(onefile)
                    paths.add(histdir + '/' + filepattern)
#                    print fullpath+': '+histdir

gitdir = subprocess.check_output(['git', 'rev-parse', '--show-toplevel']).rstrip()
os.chdir(gitdir)

cmd = ['gitk', '--'] + sorted(paths)
print ' '.join(cmd)
subprocess.call(cmd)
